name: Security Pipeline (Build + Image Scan)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    
permissions:
  contents: write
  actions: write
  repository_dispatch: write

env:
  IMAGE_VOTE: example-voting-app-vote:latest
  IMAGE_RESULT: example-voting-app-result:latest
  IMAGE_WORKER: example-voting-app-worker:latest
  BUILD_CACHE_PATH: /tmp/.buildx-cache

jobs:
  security-scans:
    name: Run Security Scans + Build + Image Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ----------------------------------------
      # CHECKOUT
      # ----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------
      # DIRECTORIES
      # ----------------------------------------
      - name: Create logs & cache dirs
        run: |
          mkdir -p logs/gitleaks logs/bandit logs/snyk logs/trivy logs/sbom $BUILD_CACHE_PATH

      # ----------------------------------------
      # INSTALL TOOLS
      # ----------------------------------------
      - name: Install All Security Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl jq git python3 python3-pip gnupg lsb-release build-essential

          sudo apt-get install -y nodejs npm
          pip3 install bandit
          npm install -g snyk

          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

          GITLEAKS_VERSION="8.18.2"
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          tar -xzf gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          sudo chmod +x /usr/local/bin/gitleaks

      # ----------------------------------------
      # RESTORE BUILDX CACHE
      # ----------------------------------------
      - name: Restore docker buildx cache
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATH }}
          key: buildx-cache-${{ github.sha }}
          restore-keys: |
            buildx-cache-

      # ----------------------------------------
      # SETUP BUILDX
      # ----------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------------------
      # SCANS (Raw JSON output)
      # ----------------------------------------
      - name: Run Gitleaks (JSON)
        run: |
          mkdir -p logs/gitleaks
          gitleaks detect \
            --no-git \
            --config=.gitleaks.toml \
            --source . \
            --redact \
            --report-format json \
            --report-path logs/gitleaks/gitleaks-latest.json \
            --exit-code 0

      - name: Run Bandit
        run: |
          bandit -r vote/ -f json -o logs/bandit/bandit-latest.json || true

      - name: Snyk Auth
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Scan - Vote
        run: snyk test --file=vote/requirements.txt --package-manager=pip --severity-threshold=high --skip-unresolved --json > logs/snyk/snyk-vote.json || true

      - name: Snyk Scan - Result
        run: snyk test --file=result/package.json --severity-threshold=high --skip-unresolved --json > logs/snyk/snyk-result.json || true

      - name: Snyk Scan - Worker
        run: snyk test --file=worker/Worker.csproj --severity-threshold=high --skip-unresolved --json > logs/snyk/snyk-worker.json || true

      - name: Trivy FS Scan
        run: trivy fs . --severity HIGH,CRITICAL --format json --output logs/trivy/trivy-fs.json || true

      - name: Trivy Config Scan
        run: trivy config . --severity HIGH,CRITICAL --format json --output logs/trivy/trivy-config.json || true

      # ----------------------------------------
      # BUILD IMAGES
      # ----------------------------------------
      - name: Build Vote image
        run: docker build --progress=plain --tag $IMAGE_VOTE vote/

      - name: Build Result image
        run: docker build --progress=plain --tag $IMAGE_RESULT result/

      - name: Build Worker image
        run: docker build --progress=plain --tag $IMAGE_WORKER worker/

      # ----------------------------------------
      # SAVE BUILDX CACHE
      # ----------------------------------------
      - name: Save docker build cache
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATH }}
          key: buildx-cache-${{ github.sha }}

      # ----------------------------------------
      # TRIVY IMAGE SCANS
      # ----------------------------------------
      - name: Trivy Image Scan - Vote
        run: trivy image --severity HIGH,CRITICAL --ignorefile .trivyignore --format json --output logs/trivy/trivy-image-vote.json $IMAGE_VOTE || true

      - name: Trivy Image Scan - Result
        run: trivy image --severity HIGH,CRITICAL --ignorefile .trivyignore --format json --output logs/trivy/trivy-image-result.json $IMAGE_RESULT || true

      - name: Trivy Image Scan - Worker
        run: trivy image --severity HIGH,CRITICAL --ignorefile .trivyignore --format json --output logs/trivy/trivy-image-worker.json $IMAGE_WORKER || true

      # ----------------------------------------
      # SBOM GENERATION
      # ----------------------------------------
      - name: Syft SBOM - Vote
        run: |
          syft vote/ -o json > logs/sbom/sbom-vote.json
          syft vote/ -o cyclonedx-json > logs/sbom/sbom-vote.cdx.json

      - name: Syft SBOM - Result
        run: |
          syft result/ -o json > logs/sbom/sbom-result.json
          syft result/ -o cyclonedx-json > logs/sbom/sbom-result.cdx.json

      - name: Syft SBOM - Worker
        run: |
          syft worker/ -o json > logs/sbom/sbom-worker.json
          syft worker/ -o cyclonedx-json > logs/sbom/sbom-worker.cdx.json

      # ----------------------------------------
      # TRIVY SBOM SCANS
      # ----------------------------------------
      - name: Trivy SBOM Scan - Vote
        run: trivy sbom logs/sbom/sbom-vote.cdx.json --severity HIGH,CRITICAL --ignorefile .trivyignore --format json --output logs/trivy/trivy-sbom-vote.json || true

      - name: Trivy SBOM Scan - Result
        run: trivy sbom logs/sbom/sbom-result.cdx.json --severity HIGH,CRITICAL --ignorefile .trivyignore --format json --output logs/trivy/trivy-sbom-result.json || true

      - name: Trivy SBOM Scan - Worker
        run: trivy sbom logs/sbom/sbom-worker.cdx.json --severity HIGH,CRITICAL --ignorefile .trivyignore --format json --output logs/trivy/trivy-sbom-worker.json || true

      # =====================================================
      # LOG AGGREGATION (ALWAYS RUN)
      # =====================================================

      - name: Generate Gitleaks History Log
        if: always()
        run: |
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          json="logs/gitleaks/gitleaks-latest.json"
          hist="logs/gitleaks/gitleaks-history.log"
          echo "==== GITLEAKS SCAN $timestamp ====" >> "$hist"
          count=$(jq 'length' "$json" 2>/dev/null || echo 0)
          echo "Leaks Found: $count" >> "$hist"
          jq -c '.[]' "$json" >> "$hist" 2>/dev/null || true

      - name: Generate Bandit History Log
        if: always()
        run: |
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          json="logs/bandit/bandit-latest.json"
          hist="logs/bandit/bandit-history.log"
          echo "==== BANDIT SCAN $timestamp ====" >> "$hist"
          jq '.' "$json" >> "$hist" 2>/dev/null || true

      - name: Generate Snyk History Log
        if: always()
        run: |
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          hist="logs/snyk/snyk-history.log"
          echo "==== SNYK SCAN $timestamp ====" >> "$hist"
          for f in logs/snyk/*.json; do
            echo "=== $(basename "$f") ===" >> "$hist"
            jq '.' "$f" >> "$hist" 2>/dev/null || true
          done

      - name: Generate Trivy History Log
        if: always()
        run: |
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          hist="logs/trivy/trivy-history.log"
          echo "==== TRIVY SCAN $timestamp ====" >> "$hist"
          for f in logs/trivy/*.json; do
            echo "=== $(basename "$f") ===" >> "$hist"
            jq '.' "$f" >> "$hist" 2>/dev/null || true
          done

      - name: Generate SBOM History Log
        if: always()
        run: |
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          hist="logs/sbom/sbom-history.log"

          echo "==== SBOM (Syft) $timestamp ====" >> "$hist"

          for f in logs/sbom/sbom-*.json; do
            if [ -f "$f" ]; then
              echo "" >> "$hist"
              echo "=== $(basename "$f") ===" >> "$hist"
              jq '.' "$f" >> "$hist" 2>/dev/null || true
            else
              echo "Missing: $f" >> "$hist"
            fi
          done


      # =====================================================
      # ENFORCEMENT (FAIL PIPELINE)
      # =====================================================

      - name: Enforce Gitleaks Policy
        run: |
          json="logs/gitleaks/gitleaks-latest.json"
          count=$(jq 'length' "$json" 2>/dev/null || echo 0)
          if [ "$count" -gt 0 ]; then
            echo "Gitleaks found leaks — failing pipeline."
            exit 1
          fi

      - name: Enforce Bandit Policy
        run: |
          json="logs/bandit/bandit-latest.json"
          high=$(jq '.metrics."_totals"."SEVERITY.HIGH"' "$json" 2>/dev/null || echo 0)
          if [ "$high" -gt 0 ]; then
            echo "Bandit HIGH issues — failing."
            exit 1
          fi

      - name: Enforce Snyk Policy
        run: |
          failed=0
          for f in logs/snyk/*.json; do
            count=$(jq '.vulnerabilities | length' "$f" 2>/dev/null || echo 0)
            if [ "$count" -gt 0 ]; then failed=1; fi
          done
          if [ "$failed" -ne 0 ]; then exit 1; fi

      - name: Enforce Trivy Policy (Config + SBOM)
        run: |
          failed=0
          files=(
            "logs/trivy/trivy-config.json"
            "logs/trivy/trivy-sbom-vote.json"
            "logs/trivy/trivy-sbom-result.json"
            "logs/trivy/trivy-sbom-worker.json"
          )
          for f in "${files[@]}"; do
            count=$(jq '[.. | objects | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' "$f" 2>/dev/null || echo 0)
            if [ "$count" -gt 0 ]; then failed=1; fi
          done
          if [ "$failed" -ne 0 ]; then exit 1; fi

      # ----------------------------------------
      # UPLOAD ARTIFACTS (ALWAYS)
      # ----------------------------------------
      - name: Upload Security Reports & Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-logs-and-reports
          path: logs/**

      # ----------------------------------------
      # TRIGGER BUILD PIPELINE
      # ----------------------------------------
      - name: Trigger Build & Push Pipeline
        if: github.event_name == 'push' && success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: y7ksh-r/example-voting-app
          event-type: trigger-build-pipeline

